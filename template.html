<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PAGE</title>
    <style>
        a {
            color: #aaaaff;
            font-weight: bold;
        }
        .focus a {
            color: black;
        }
    </style>
    <script>%%WS_URL%%</script>
</head>
<body>
  <h1>My token</h1>
  <ul>
      %%tokens%%
  </ul>
  <hr/>
  <h1>Message</h1>
  <form>
      <div><label>ID:<br/><select id="msg_id" name="id">%%options%%</select></label></div>
      <div><label>TYPE:<br/><input id="msg_type" name="type" type="text" placeholder="type" value="t1"/></label></div>
      <div><label>TEXT:<br/><input id="msg_text" name="text" type="text" placeholder="text" value="Hi"/></label></div>
      <div><label>LINK:<br/><input id="msg_link" name="link" type="text" placeholder="link" value="https://ya.ru"/></label></div>
      <input id="msg_send" type="button" disabled value="Send"/>
  </form>
  <hr/>
  <h1>Inbox</h1>
  <div id="inbox"></div>
  <script>
      const msg_send = document.getElementById('msg_send')
      const msg_id = document.getElementById('msg_id')
      const msg_type = document.getElementById('msg_type')
      const msg_text = document.getElementById('msg_text')
      const msg_link = document.getElementById('msg_link')
      const inbox = document.getElementById('inbox')

      function Connect(url) {
          var ws = new WebSocket(url)

          ws.onopen = () => {//sock.send('hey')
              msg_send.disabled = false
              ws.send(JSON.stringify({client_say:'I am conected', d: new Date().toLocaleTimeString()}))
          }

          ws.onclose = event => {
              msg_send.disabled = true
              setTimeout(function(){
                  console.log('try reconnect')
                  Connect(url)
              }, 5000)
          }

          ws.onerror = error => { console.log('WebSocket error:', error); }

          ws.onmessage = e => {
              //console.log(e);
              var json=null,text=null;
              try{json=JSON.parse(e.data);}catch(ex){text=e.data;}
              if (null!==json){
                  console.log('JSON: ', json)
                  inbox.innerHTML +=  JSON.stringify(json) + "<br/>\n"
              }else {
                  console.log('TEXT: ',text)
              }
          }
      }

      msg_send.addEventListener('click', event=>{
          const body = JSON.stringify({
              id: Number(msg_id.value),
              type: msg_type.value,
              text: msg_text.value,
              link: msg_link.value,
          })
          fetch('/api.php', {method:'POST', body})
          //fetch('http://ws-riky:3210', {method:'POST', body})
      })
      Connect(WS_URL)

  </script>
</body>
</html>